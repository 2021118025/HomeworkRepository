<!DOCTYPE html>
<html lang = "ko">
<head>
    <meta charset = "UTF-8">
    <meta name = "viewport" content = "width=device-width, initial-scale=1.0">
    <title>ë©”ì¸í˜ì´ì§€</title>
    <link rel = "stylesheet" type = "text/css" href = "main.css">
</head>

<body>
  <div id = "wrap">
    <header class = "header">
      <div class = "header-txt">ì¸í”„ë° ì˜í™” ì •ë³´ ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤.</div>
      <nav class = "nav">
        <a href = "index.html" class = "active">ë©”ì¸í˜ì´ì§€</a>
        <a href = "login.html">ë¡œê·¸ì¸</a>
        <a href = "signup.html">íšŒì›ê°€ì…</a>
      </nav>
    </header>

    <main class = "main">
      <div id = "filtering">
        <input type = "text" id = "search" placeholder = "í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
        <button id = "btn">Filter results</button>
      </div>

      <div class = "article-txt">Movies</div>

      <section class = "movie-section">
        
        <div class = "sort-panel">
          <div><strong>ì •ë ¬ ê¸°ì¤€</strong></div>
          <label><input type = "radio" name = "sort" value = "rating-desc"> í‰ì  ë‚´ë¦¼ì°¨ìˆœ</label><br>
          <label><input type = "radio" name = "sort" value = "rating-asc"> í‰ì  ì˜¤ë¦„ì°¨ìˆœ</label><br>
          <label><input type = "radio" name = "sort" value = "date-desc"> ê°œë´‰ ë‚´ë¦¼ì°¨ìˆœ</label><br>
          <label><input type = "radio" name = "sort" value = "date-asc"> ê°œë´‰ ì˜¤ë¦„ì°¨ìˆœ</label>
        </div>

        <div class = "movie-grid" id = "movie-grid"></div>
      </section>
    </main>
  </div>

  <script>
const movieGrid = document.getElementById("movie-grid");
const searchInput = document.getElementById("search");
const filterBtn = document.getElementById("btn");

let displayedMovies = [];
let renderedCount = 0;
const batchSize = 8;

// ì˜í™” ì¹´ë“œ ë Œë”ë§
function renderNextBatch(data) {
  const nextBatch = data.slice(renderedCount, renderedCount + batchSize);
  nextBatch.forEach(movie => {
    const card = document.createElement("div");
    card.className = "movie-card";
    card.innerHTML = `
      <div class="poster-wrap">
        <img src="${movie.movie_image}" alt="${movie.movie_title}">
        <div class="overlay"><strong>ì¤„ê±°ë¦¬:</strong><br>${movie.movie_overview}</div>
      </div>
      <div class="movie-title">${movie.movie_title}</div>
      <div class="movie-date">ğŸ“… ${movie.movie_release_date}</div>
      <div class="movie-rating">â­ ${movie.movie_rate}/10</div>
    `;
    card.addEventListener("click", () => {
      window.location.href = `/movie.html?movie_id=${movie.movie_id}`;
    });
    movieGrid.appendChild(card);
  });
  renderedCount += batchSize;
}

// ë¬´í•œ ìŠ¤í¬ë¡¤
window.addEventListener("scroll", () => {
  if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
    renderNextBatch(displayedMovies);
  }
});

// ì˜í™” ë¶ˆëŸ¬ì˜¤ê¸° (ê²€ìƒ‰ + ì •ë ¬ í¬í•¨)
function fetchAndRenderMovies() {
  const keyword = searchInput.value.trim();
  const selectedSort = document.querySelector('input[name="sort"]:checked')?.value || "";

  const query = `/api/movies?keyword=${encodeURIComponent(keyword)}&sort=${selectedSort}`;
  fetch(query)
    .then(res => res.json())
    .then(data => {
      displayedMovies = data;
      movieGrid.innerHTML = "";
      renderedCount = 0;
      renderNextBatch(displayedMovies);
    });
}

// ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ
filterBtn.addEventListener("click", fetchAndRenderMovies);

// ì •ë ¬ ë²„íŠ¼ í´ë¦­ ì‹œ
document.querySelectorAll('input[name="sort"]').forEach(input => {
  input.addEventListener("change", fetchAndRenderMovies);
});

// í˜ì´ì§€ ìµœì´ˆ ë¡œë“œ ì‹œ ì „ì²´ ì˜í™” í‘œì‹œ
fetchAndRenderMovies();
</script>


</body>
</html>